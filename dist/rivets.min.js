// Rivets.js
// version: 0.5.2
// author: Michael Richards
// license: MIT
(function(){var a,b=function(a,b){return function(){return a.apply(b,arguments)}},c=[].slice,d=[].indexOf||function(a){for(var b=0,c=this.length;c>b;b++)if(b in this&&this[b]===a)return b;return-1};a={},String.prototype.trim||(String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")}),a.Binding=function(){function d(a,c,d,e,f,g){var h,i,j,k;if(this.view=a,this.el=c,this.type=d,this.key=e,this.keypath=f,this.options=null!=g?g:{},this.update=b(this.update,this),this.unbind=b(this.unbind,this),this.bind=b(this.bind,this),this.publish=b(this.publish,this),this.sync=b(this.sync,this),this.set=b(this.set,this),this.formattedValue=b(this.formattedValue,this),!(this.binder=this.view.binders[this.type])){k=this.view.binders;for(h in k)j=k[h],"*"!==h&&-1!==h.indexOf("*")&&(i=new RegExp("^"+h.replace("*",".+")+"$"),i.test(this.type)&&(this.binder=j,this.args=new RegExp("^"+h.replace("*","(.+)")+"$").exec(this.type),this.args.shift()))}this.binder||(this.binder=this.view.binders["*"]),this.binder instanceof Function&&(this.binder={routine:this.binder}),this.formatters=this.options.formatters||[],this.model=this.view.models[this.key]}return d.prototype.formattedValue=function(a){var b,d,e,f,g,h;for(h=this.formatters,f=0,g=h.length;g>f;f++)d=h[f],b=d.split(/\s+/),e=b.shift(),d=this.model[e]instanceof Function?this.model[e]:this.view.formatters[e],(null!=d?d.read:void 0)instanceof Function?a=d.read.apply(d,[a].concat(c.call(b))):d instanceof Function&&(a=d.apply(null,[a].concat(c.call(b))));return a},d.prototype.set=function(a){var b;return a=this.formattedValue(a instanceof Function&&!this.binder["function"]?a.call(this.model):a),null!=(b=this.binder.routine)?b.call(this,this.el,a):void 0},d.prototype.sync=function(){return this.set(this.options.bypass?this.model[this.keypath]:this.view.config.adapter.read(this.model,this.keypath))},d.prototype.publish=function(){var b,d,e,f,g,h,i,j,k;for(f=a.Util.getInputValue(this.el),i=this.formatters.slice(0).reverse(),g=0,h=i.length;h>g;g++)d=i[g],b=d.split(/\s+/),e=b.shift(),(null!=(j=this.view.formatters[e])?j.publish:void 0)&&(f=(k=this.view.formatters[e]).publish.apply(k,[f].concat(c.call(b))));return this.view.config.adapter.publish(this.model,this.keypath,f)},d.prototype.bind=function(){var a,b,c,d,e,f,g,h,i;if(null!=(f=this.binder.bind)&&f.call(this,this.el),this.options.bypass?this.sync():(this.view.config.adapter.subscribe(this.model,this.keypath,this.sync),this.view.config.preloadData&&this.sync()),null!=(g=this.options.dependencies)?g.length:void 0){for(h=this.options.dependencies,i=[],d=0,e=h.length;e>d;d++)a=h[d],/^\./.test(a)?(c=this.model,b=a.substr(1)):(a=a.split("."),c=this.view.models[a.shift()],b=a.join(".")),i.push(this.view.config.adapter.subscribe(c,b,this.sync));return i}},d.prototype.unbind=function(){var a,b,c,d,e,f,g,h,i;if(null!=(f=this.binder.unbind)&&f.call(this,this.el),this.options.bypass||this.view.config.adapter.unsubscribe(this.model,this.keypath,this.sync),null!=(g=this.options.dependencies)?g.length:void 0){for(h=this.options.dependencies,i=[],d=0,e=h.length;e>d;d++)a=h[d],/^\./.test(a)?(c=this.model,b=a.substr(1)):(a=a.split("."),c=this.view.models[a.shift()],b=a.join(".")),i.push(this.view.config.adapter.unsubscribe(c,b,this.sync));return i}},d.prototype.update=function(){return this.unbind(),this.model=this.view.models[this.key],this.bind()},d}(),a.View=function(){function c(c,d,e){var f,g,h,i,j,k,l,m,n;for(this.els=c,this.models=d,this.options=null!=e?e:{},this.update=b(this.update,this),this.publish=b(this.publish,this),this.sync=b(this.sync,this),this.unbind=b(this.unbind,this),this.bind=b(this.bind,this),this.select=b(this.select,this),this.build=b(this.build,this),this.bindingRegExp=b(this.bindingRegExp,this),this.els.jquery||this.els instanceof Array||(this.els=[this.els]),l=["config","binders","formatters"],j=0,k=l.length;k>j;j++){if(g=l[j],this[g]={},this.options[g]){m=this.options[g];for(f in m)h=m[f],this[g][f]=h}n=a[g];for(f in n)h=n[f],null==(i=this[g])[f]&&(i[f]=h)}this.build()}return c.prototype.bindingRegExp=function(){var a;return a=this.config.prefix,a?new RegExp("^data-"+a+"-"):/^data-/},c.prototype.build=function(){var b,c,e,f,g,h,i,j,k,l,m,n=this;for(this.bindings=[],g=[],b=this.bindingRegExp(),f=function(c){var e,f,h,i,j,k,l,m,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H;if(d.call(g,c)<0){for(E=c.attributes,y=0,B=E.length;B>y;y++)if(e=E[y],b.test(e.name)){if(w=e.name.replace(b,""),!(h=n.binders[w])){F=n.binders;for(l in F)x=F[l],"*"!==l&&-1!==l.indexOf("*")&&(u=new RegExp("^"+l.replace("*",".+")+"$"),u.test(w)&&(h=x))}if(h||(h=n.binders["*"]),h.block){for(G=c.getElementsByTagName("*"),z=0,C=G.length;C>z;z++)p=G[z],g.push(p);f=[e]}}for(H=f||c.attributes,A=0,D=H.length;D>A;A++)e=H[A],b.test(e.name)&&(q={},w=e.name.replace(b,""),t=function(){var a,b,c,d;for(c=e.value.split("|"),d=[],a=0,b=c.length;b>a;a++)s=c[a],d.push(s.trim());return d}(),i=function(){var a,b,c,d;for(c=t.shift().split("<"),d=[],a=0,b=c.length;b>a;a++)j=c[a],d.push(j.trim());return d}(),r=i.shift(),v=r.split(/\.|:/),q.formatters=t,q.bypass=-1!==r.indexOf(":"),v[0]?m=v.shift():(m=null,v.shift()),o=v.join("."),null!=n.models[m]&&((k=i.shift())&&(q.dependencies=k.split(/\s+/)),n.bindings.push(new a.Binding(n,c,w,m,o,q))));f&&(f=null)}},l=this.els,h=0,j=l.length;j>h;h++)for(c=l[h],f(c),m=c.getElementsByTagName("*"),i=0,k=m.length;k>i;i++)e=m[i],null!=e.attributes&&f(e)},c.prototype.select=function(a){var b,c,d,e,f;for(e=this.bindings,f=[],c=0,d=e.length;d>c;c++)b=e[c],a(b)&&f.push(b);return f},c.prototype.bind=function(){var a,b,c,d,e;for(d=this.bindings,e=[],b=0,c=d.length;c>b;b++)a=d[b],e.push(a.bind());return e},c.prototype.unbind=function(){var a,b,c,d,e;for(d=this.bindings,e=[],b=0,c=d.length;c>b;b++)a=d[b],e.push(a.unbind());return e},c.prototype.sync=function(){var a,b,c,d,e;for(d=this.bindings,e=[],b=0,c=d.length;c>b;b++)a=d[b],e.push(a.sync());return e},c.prototype.publish=function(){var a,b,c,d,e;for(d=this.select(function(a){return a.binder.publishes}),e=[],b=0,c=d.length;c>b;b++)a=d[b],e.push(a.publish());return e},c.prototype.update=function(a){var b,c,d,e;null==a&&(a={}),e=[];for(c in a)d=a[c],this.models[c]=d,e.push(function(){var a,d,e,f;for(e=this.select(function(a){return a.key===c}),f=[],a=0,d=e.length;d>a;a++)b=e[a],f.push(b.update());return f}.call(this));return e},c}(),a.Util={bindEvent:function(a,b,c,d){var e;return e=function(a){return c.call(this,a,d)},null!=window.jQuery?(a=jQuery(a),null!=a.on?a.on(b,e):a.bind(b,e)):null!=window.addEventListener?a.addEventListener(b,e,!1):(b="on"+b,a.attachEvent(b,e)),e},unbindEvent:function(a,b,c){return null!=window.jQuery?(a=jQuery(a),null!=a.off?a.off(b,c):a.unbind(b,c)):window.removeEventListener?a.removeEventListener(b,c,!1):(b="on"+b,a.detachEvent(b,c))},getInputValue:function(a){var b,c,d,e;if(null!=window.jQuery)switch(a=jQuery(a),a[0].type){case"checkbox":return a.is(":checked");default:return a.val()}else switch(a.type){case"checkbox":return a.checked;case"select-multiple":for(e=[],c=0,d=a.length;d>c;c++)b=a[c],b.selected&&e.push(b.value);return e;default:return a.value}}},a.binders={enabled:function(a,b){return a.disabled=!b},disabled:function(a,b){return a.disabled=!!b},checked:{publishes:!0,bind:function(b){return this.currentListener=a.Util.bindEvent(b,"change",this.publish)},unbind:function(b){return a.Util.unbindEvent(b,"change",this.currentListener)},routine:function(a,b){var c;return a.checked="radio"===a.type?(null!=(c=a.value)?c.toString():void 0)===(null!=b?b.toString():void 0):!!b}},unchecked:{publishes:!0,bind:function(b){return this.currentListener=a.Util.bindEvent(b,"change",this.publish)},unbind:function(b){return a.Util.unbindEvent(b,"change",this.currentListener)},routine:function(a,b){var c;return a.checked="radio"===a.type?(null!=(c=a.value)?c.toString():void 0)!==(null!=b?b.toString():void 0):!b}},show:function(a,b){return a.style.display=b?"":"none"},hide:function(a,b){return a.style.display=b?"none":""},html:function(a,b){return a.innerHTML=null!=b?b:""},value:{publishes:!0,bind:function(b){return this.currentListener=a.Util.bindEvent(b,"change",this.publish)},unbind:function(b){return a.Util.unbindEvent(b,"change",this.currentListener)},routine:function(a,b){var c,e,f,g,h,i,j;if(null!=window.jQuery){if(a=jQuery(a),(null!=b?b.toString():void 0)!==(null!=(g=a.val())?g.toString():void 0))return a.val(null!=b?b:"")}else if("select-multiple"===a.type){if(null!=b){for(j=[],e=0,f=a.length;f>e;e++)c=a[e],j.push(c.selected=(h=c.value,d.call(b,h)>=0));return j}}else if((null!=b?b.toString():void 0)!==(null!=(i=a.value)?i.toString():void 0))return a.value=null!=b?b:""}},text:function(a,b){return null!=a.innerText?a.innerText=null!=b?b:"":a.textContent=null!=b?b:""},"on-*":{"function":!0,routine:function(b,c){return this.currentListener&&a.Util.unbindEvent(b,this.args[0],this.currentListener),this.currentListener=a.Util.bindEvent(b,this.args[0],c,this.view)}},"each-*":{block:!0,bind:function(a){return a.removeAttribute(["data",this.view.config.prefix,this.type].join("-").replace("--","-"))},unbind:function(){var a,b,c,d,e;if(null!=this.iterated){for(d=this.iterated,e=[],b=0,c=d.length;c>b;b++)a=d[b],e.push(a.unbind());return e}},routine:function(b,c){var d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z;if(null!=this.iterated)for(u=this.iterated,o=0,r=u.length;r>o;o++)for(n=u[o],n.unbind(),v=n.els,p=0,s=v.length;s>p;p++)e=v[p],e.parentNode.removeChild(e);else this.marker=document.createComment(" rivets: "+this.type+" "),b.parentNode.insertBefore(this.marker,b),b.parentNode.removeChild(b);if(this.iterated=[],c){for(z=[],q=0,t=c.length;t>q;q++){f=c[q],d={},w=this.view.models;for(j in w)i=w[j],d[j]=i;if(d[this.args[0]]=f,g=b.cloneNode(!0),l=this.iterated.length?this.iterated[this.iterated.length-1].els[0]:this.marker,this.marker.parentNode.insertBefore(g,null!=(x=l.nextSibling)?x:null),k={binders:this.view.options.binders,formatters:this.view.options.binders,config:{}},this.view.options.config){y=this.view.options.config;for(h in y)m=y[h],k.config[h]=m}k.config.preloadData=!0,n=new a.View(g,d,k),n.bind(),z.push(this.iterated.push(n))}return z}}},"class-*":function(a,b){var c;return c=" "+a.className+" ",!b==(-1!==c.indexOf(" "+this.args[0]+" "))?a.className=b?""+a.className+" "+this.args[0]:c.replace(" "+this.args[0]+" "," ").trim():void 0},"*":function(a,b){return b?a.setAttribute(this.type,b):a.removeAttribute(this.type)}},a.config={preloadData:!0},a.formatters={},a.factory=function(b){return b.binders=a.binders,b.formatters=a.formatters,b.config=a.config,b.configure=function(b){var c,d;null==b&&(b={});for(c in b)d=b[c],a.config[c]=d},b.bind=function(b,c,d){var e;return null==c&&(c={}),null==d&&(d={}),e=new a.View(b,c,d),e.bind(),e}},"object"==typeof exports?a.factory(exports):"function"==typeof define&&define.amd?define(["exports"],function(b){return a.factory(this.rivets=b),b}):a.factory(this.rivets={})}).call(this);